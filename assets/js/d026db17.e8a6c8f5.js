"use strict";(self.webpackChunkfiber_website=self.webpackChunkfiber_website||[]).push([[243],{3905:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>g});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},h=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,h=l(e,["components","mdxType","originalType","parentName"]),c=p(n),g=r,m=c["".concat(s,".").concat(g)]||c[g]||u[g]||o;return n?a.createElement(m,i(i({ref:t},h),{},{components:n})):a.createElement(m,i({ref:t},h))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8702:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const o={slug:"ethereum-hotspots",title:"Identifying hotspots on the Ethereum p2p network",authors:["jonas"],tags:["ethereum","devp2p"]},i=void 0,l={permalink:"/blog/ethereum-hotspots",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-10-21-ethereum-hotspots/index.md",source:"@site/blog/2022-10-21-ethereum-hotspots/index.md",title:"Identifying hotspots on the Ethereum p2p network",description:"In our journey of creating the ideal network topology for our Fiber nodes, we had to determine the critical geographical",date:"2022-10-21T00:00:00.000Z",formattedDate:"October 21, 2022",tags:[{label:"ethereum",permalink:"/blog/tags/ethereum"},{label:"devp2p",permalink:"/blog/tags/devp-2-p"}],readingTime:7.425,hasTruncateMarker:!0,authors:[{name:"Jonas Bostoen",title:"Chainbound CTO",url:"https://github.com/jonasbostoen",imageURL:"https://github.com/jonasbostoen.png",key:"jonas"}],frontMatter:{slug:"ethereum-hotspots",title:"Identifying hotspots on the Ethereum p2p network",authors:["jonas"],tags:["ethereum","devp2p"]},prevItem:{title:"Diving into the Reth p2p stack",permalink:"/blog/reth-p2p"}},s={authorsImageUrls:[void 0]},p=[{value:"The setup",id:"the-setup",level:2},{value:"The results",id:"the-results",level:2},{value:"Geography",id:"geography",level:3},{value:"Hosting providers",id:"hosting-providers",level:3},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}],h={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},h,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,'In our journey of creating the ideal network topology for our Fiber nodes, we had to determine the critical geographical\nregions of the Ethereum p2p network. We will define these "hotspots" as regions where the most transactions are originally\nbroadcasted from.'),(0,r.kt)("p",null,"Because Fiber is a mempool service, we need to be able to deliver transactions to users as fast as possible, which also means making sure we sufficiently cover these hotspots. In essence, we want to make sure we're as close to the original\nbroadcaster is possible, which in p2p terms means either being directly connected to it, or only 1 or 2 hops away. Each hop\nwill introduce a non-trivial amount of latency, which is something we need to minimize."),(0,r.kt)("p",null,"Let's look at a couple scenarios:"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(3411).Z,width:"2088",height:"1126"})),(0,r.kt)("p",null,"In this setup, we're 2 hops away from the transaction broadcaster. We'll simplify here and assume that nodes always\nbroadcast the full transaction message, which is not the case ",(0,r.kt)("a",{parentName:"p",href:"#references"},"[2]"),"."),(0,r.kt)("p",null,"There are 3 factors introducing latency here:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"A"),": The first network hop."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"B"),": The time it takes this node to process, validate, and re-broadcast the transaction."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"C"),": The second network hop.")),(0,r.kt)("p",null,"This network topology is not ideal, since your total latency will be ",(0,r.kt)("strong",{parentName:"p"},"A + B + C"),", and all of these steps\nhave an element of variability to them."),(0,r.kt)("p",null,"What we actually want is the following, single hop topology:"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(735).Z,width:"2088",height:"1126"})),(0,r.kt)("p",null,"Here, the only latency we have is ",(0,r.kt)("strong",{parentName:"p"},"A"),", the first and only network hop. The only way to achieve this is to try\nto ",(0,r.kt)("strong",{parentName:"p"},"connect to as much peers as possible in that region"),", which will give you a better chance of direct peerings\nwith transaction broadcasters. You can do this by either having one node with a very large maximum peer count, or by having more\nthan one node in the region. Because maintaining a large amount of peers is pretty resource intensive, we opted\nfor the second option."),(0,r.kt)("p",null,"Now that we know why we need to cover these hotspots sufficiently, how do we identify them?\nThis article will go over our findings."),(0,r.kt)("h2",{id:"the-setup"},"The setup"),(0,r.kt)("p",null,"The setup will consist of a number of Ethereum nodes deployed globally that ",(0,r.kt)("strong",{parentName:"p"},"keep track of when they received a certain transaction, but also from which peer it came"),".\nLater on, we'll be able to inspect these timestamps to see which node heard about the transaction first.\nWe'll also be able to use the peer IP addresses to find which hosting providers are responsible for broadcasting\nthe most transactions. But where do we deploy these nodes?"),(0,r.kt)("p",null,"It's no secret that ",(0,r.kt)("strong",{parentName:"p"},"most critical Ethereum infrastructure runs on AWS")," ",(0,r.kt)("a",{parentName:"p",href:"#references"},"[1]"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(7746).Z,width:"1350",height:"762"})),(0,r.kt)("p",null,"Which is why we deployed our nodes in the following 13 AWS regions:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"us-east-1 (N. Virginia)"),(0,r.kt)("li",{parentName:"ul"},"us-east-2 (Ohio)"),(0,r.kt)("li",{parentName:"ul"},"us-west-1 (N. California)"),(0,r.kt)("li",{parentName:"ul"},"us-west-2 (Oregon)"),(0,r.kt)("li",{parentName:"ul"},"ap-east-1 (Hong Kong)"),(0,r.kt)("li",{parentName:"ul"},"ap-northeast-2 (Seoul)"),(0,r.kt)("li",{parentName:"ul"},"ap-northeast-1 (Tokyo)"),(0,r.kt)("li",{parentName:"ul"},"ap-southeast-1 (Singapore)"),(0,r.kt)("li",{parentName:"ul"},"eu-west-1 (Ireland)"),(0,r.kt)("li",{parentName:"ul"},"eu-west-2 (London)"),(0,r.kt)("li",{parentName:"ul"},"eu-west-3 (Paris)"),(0,r.kt)("li",{parentName:"ul"},"eu-north-1 (Stockholm) ")),(0,r.kt)("p",null,"This obviously doesn't cover the whole world, but since they're located at backbone hotspots, it will do."),(0,r.kt)("p",null,"Each node will be connected to a significant amount of peers (400), ",(0,r.kt)("strong",{parentName:"p"},"for a theoretical\nmaximum reach of 5200 peers"),". In practice, this number will be a lot lower due to duplicate peers.\nWith this setup, we've recorded ",(0,r.kt)("strong",{parentName:"p"},"5.5 million Ethereum transactions")," over the period of a couple of days. Let's look at the results."),(0,r.kt)("h2",{id:"the-results"},"The results"),(0,r.kt)("h3",{id:"geography"},"Geography"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(2365).Z,width:"1400",height:"1000"}),"\nMost transactions are seen first in the US in the North Virginia area, which is\nwhere the notorious ",(0,r.kt)("strong",{parentName:"p"},"us-east-1")," AWS region sits. Ohio is a hotspot as well, seeing\na little more than 8% of transactions first. Regions on the West Coast are less active:\nOregon and North California combined only see a little more than 5% of transactions first."),(0,r.kt)("p",null,"In ",(0,r.kt)("strong",{parentName:"p"},"Europe"),", Frankfurt is by far the most active region. Paris and London are also important\nregions, both seeing close to 6% of recorded transactions first. In the ",(0,r.kt)("strong",{parentName:"p"},"Asia Pacific")," region, Tokyo and Singapore are the most active."),(0,r.kt)("p",null,'Interestingly, looking at the activity per "continent", we can see that the EU and the US lead by a wide margin:\n',(0,r.kt)("img",{src:n(4786).Z,width:"1400",height:"1000"})),(0,r.kt)("p",null,"Based on these results, we've been able to work out a good geographical distribution of our node setup."),(0,r.kt)("h3",{id:"hosting-providers"},"Hosting providers"),(0,r.kt)("p",null,"Since we recorded the sending peer of every transaction, we can take a closer look at the different hosting\nproviders that originate the most transactions. We know that AWS hosts a lot of full nodes, but is that actually where\ninfrastructure that belongs to the largest ",(0,r.kt)("em",{parentName:"p"},"transaction broadcasters")," is?"),(0,r.kt)("p",null,'To figure that out, we\'ll look at the top 3 most "active" peers (peers from which we received the most transactions first) per region, and identify the hosting provider based on their IP addresses.'),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"us-east-1: Virginia region")),(0,r.kt)("p",null,"All in AWS, Virginia."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"eu-central-1: Frankfurt region")),(0,r.kt)("p",null,"All in Hetzner, Frankfurt. Hetzner is a bare metal cloud provider that's primarily active in Germany."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"us-east-2: Ohio region")),(0,r.kt)("p",null,"All in AWS, Virginia. Only the 4th biggest originated from the AWS Ohio datacenter, again confirming that the us-east-1 region\nis a big hotspot."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"eu-west-3: Paris region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Google Cloud, Brussels"),(0,r.kt)("li",{parentName:"ol"},"Google Cloud, Brussels"),(0,r.kt)("li",{parentName:"ol"},"Hetzner, Frankfurt")),(0,r.kt)("p",null,"This seems to suggest that the Paris region itself is not very active."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"eu-west-2: London region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"OVHCloud, London"),(0,r.kt)("li",{parentName:"ol"},"Google Cloud, Brussels"),(0,r.kt)("li",{parentName:"ol"},"Hetzner, Frankfurt")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ap-northeast-1: Tokyo region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"AWS, Tokyo"),(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia"),(0,r.kt)("li",{parentName:"ol"},"AWS, Tokyo")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ap-southeast-1: Singapore region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Contabo, Singapore"),(0,r.kt)("li",{parentName:"ol"},"Hetzner, Frankfurt (?)"),(0,r.kt)("li",{parentName:"ol"},"AWS, Singapore")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"eu-west-1: Dublin region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"AWS, Dublin"),(0,r.kt)("li",{parentName:"ol"},"AWS, Tokyo (?)"),(0,r.kt)("li",{parentName:"ol"},"AWS, Dublin")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"us-west-2: Oregon region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Telus Communications, Vancouver"),(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia"),(0,r.kt)("li",{parentName:"ol"},"AWS, Oregon")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ap-east-1: Hong Kong region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Google Cloud, Hong Kong"),(0,r.kt)("li",{parentName:"ol"},"Google Cloud, Hong Kong"),(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia (?)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ap-northeast-2: Seoul region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"AWS, Seoul"),(0,r.kt)("li",{parentName:"ol"},"AWS, Seoul"),(0,r.kt)("li",{parentName:"ol"},"AWS, Tokyo")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"eu-north-1: Stockholm region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Hetzner, Frankfurt"),(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia (?)"),(0,r.kt)("li",{parentName:"ol"},"Hetzner, Finland")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"us-west-1: California region")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia"),(0,r.kt)("li",{parentName:"ol"},"AWS, Virginia"),(0,r.kt)("li",{parentName:"ol"},"AWS, California")),(0,r.kt)("p",null,"And putting all the winners in a table:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Region"),(0,r.kt)("th",{parentName:"tr",align:null},"Hosting Provider"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"us-east-1"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Virginia")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"eu-central-1"),(0,r.kt)("td",{parentName:"tr",align:null},"Hetzner, Frankfurt")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"us-east-2"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Ohio")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"eu-west-3"),(0,r.kt)("td",{parentName:"tr",align:null},"Google Cloud, Brussels")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"eu-west-2"),(0,r.kt)("td",{parentName:"tr",align:null},"OVH, UK")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ap-northeast-1"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Tokyo")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ap-southeast-1"),(0,r.kt)("td",{parentName:"tr",align:null},"Contabo, Singapore")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"eu-west-1"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Dublin")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"us-west-2"),(0,r.kt)("td",{parentName:"tr",align:null},"Telus Communications, Vancouver")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ap-east-1"),(0,r.kt)("td",{parentName:"tr",align:null},"Google Cloud, Hong Kong")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ap-northeast-2"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Seoul")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"eu-north-1"),(0,r.kt)("td",{parentName:"tr",align:null},"Hetzner, Frankfurt")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"us-west-1"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS, Virginia")))),(0,r.kt)("p",null,"Turns out that ",(0,r.kt)("strong",{parentName:"p"},"AWS wins only in 6 of the 13 regions"),". In Virginia and in Ohio, both very important regions, it has been the biggest broadcaster. But we also see Google Cloud winning in Hong Kong as well as in Paris (from their datacenter in Brussels, Belgium). Hetzner wins in Frankfurt by a wide margin, perhaps not surprisingly. It also wins in Stockholm, Sweden,\neven though the broadcaster was in Frankfurt. This tells us that the eu-north area does not seem to have a lot of\nactivity. Overall, Hetzner is a really active hosting provider in Europe.\nIn Oregon, the biggest broadcaster was in Vancouver, Canada. In Singapore, it came from Contabo."),(0,r.kt)("p",null,"Another interesting observation is that there's almost never one broadcaster that stands out per region. The second and\nthird biggest broadcasters are never far behind. This suggests that providers like ",(0,r.kt)("a",{parentName:"p",href:"https://www.alchemy.com/"},"Alchemy"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"https://infura.io/"},"Infura"),", who send the largest part of Ethereum transactions, use a lot of nodes, possibly\ndistributed across geographic areas."),(0,r.kt)("p",null,"You might have also noticed the slight anomalies tagged with ",(0,r.kt)("strong",{parentName:"p"},"(?)"),". These are entries that don't really make a lot of sense.\nThe fact that an AWS broadcaster in Virginia can make the top 3 active peers of our node in Hong Kong\nmeans that those transactions didn't arrive at our node in Virginia first. For now, we attribute these anomalies to the randomness\nof the p2p network, but we'll continue looking into it."),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"When milliseconds matter, this is all information that has to be taken into consideration, and that's what we did\nwith Fiber. Listening to transactions is only one aspect of high frequency trading on blockchains, but it's a very important one that one needs to get right by carefully choosing the regions, concentration, and cloud providers\nacross which to deploy nodes."),(0,r.kt)("p",null,"If you're interested in learning more about Fiber, check out the ",(0,r.kt)("a",{parentName:"p",href:"/docs/intro"},"documentation")," or\njoin the ",(0,r.kt)("a",{parentName:"p",href:"https://discord.gg/J4KNdeCYGX"},"Discord"),". We will be posting more stories like these,\nfollow us on Twitter for updates ",(0,r.kt)("a",{parentName:"p",href:"https://twitter.com/chainbound_"},"@chainbound_"),"!"),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://ethernodes.org/networkType/Hosting"},"https://ethernodes.org/networkType/Hosting")),(0,r.kt)("li",{parentName:"ol"},"In reality, the full message is only broadcast to a subset of peers, whereas the rest receive only the hash ",(0,r.kt)("strong",{parentName:"li"},"announcement"),".\nIt's up to these nodes to check if they've already received the transaction, and otherwise they have to request\nit. This introduces another round trip. See the devp2p specificiation on transaction exchange: ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/caps/eth.md#transaction-exchange"},"https://github.com/ethereum/devp2p/blob/master/caps/eth.md#transaction-exchange"))))}u.isMDXComponent=!0},735:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/1-hop-setup-0c9cde82c28ea0ab946c5bc8f4ba5fcc.png"},3411:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2-hop-setup-472f68397ff0365f93fa9e97bd880999.png"},7746:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/hosting-chart-2b4315f334068219e0601b474a7a7620.png"},2365:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/tx_geo-60d74af1388cc368069987071c6ece2f.png"},4786:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/tx_geo_continent-f11cd786698220243e35b2a6201101a5.png"}}]);